# å‘¨æŠ¥æ’­æŠ¥ PRD

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯

å½“å‰ç³»ç»Ÿå·²æœ‰ï¼š
- **æ—¥æŠ¥** (Daily Report): æ¯æ—¥ 09:10ï¼Œå¤ç›˜ T-1 æ—¥å…¨å¤©æ•°æ®
- **å®æ—¶æ’­æŠ¥** (Realtime Report): æ¯å°æ—¶æ•´ç‚¹ï¼Œç›‘æ§å½“æ—¥ç´¯è®¡æ•°æ®

**ç¼ºå¤±**ï¼šå‘¨ç»´åº¦çš„è¶‹åŠ¿åˆ†æå’Œå¤ç›˜ï¼Œç®¡ç†å±‚éœ€è¦æ›´å®è§‚çš„è§†è§’æ¥è¯„ä¼°æŠ•æ”¾ç­–ç•¥æ•ˆæœã€‚

### 1.2 ç›®æ ‡ç”¨æˆ·

| è§’è‰² | å…³æ³¨ç‚¹ |
|------|--------|
| ç®¡ç†å±‚ | å‘¨åº¦ ROI è¶‹åŠ¿ã€é¢„ç®—æ‰§è¡Œç‡ã€æˆ˜ç•¥æ–¹å‘ |
| æŠ•æ”¾è´Ÿè´£äºº | æŠ•æ‰‹å‘¨åº¦è¡¨ç°ã€å‰§é›†ç”Ÿå‘½å‘¨æœŸã€å¸‚åœºæœºä¼š |
| æŠ•æ‰‹ | ä¸ªäººå‘¨åº¦æ’åã€æ•ˆç‡å˜åŒ–ã€æ”¹è¿›æ–¹å‘ |

### 1.3 è§¦å‘æ—¶é—´

- **æ—¶é—´**: æ¯å‘¨ä¸€ 09:30
- **æ•°æ®èŒƒå›´**: ä¸Šå‘¨ä¸€è‡³å‘¨æ—¥ (W-1) å®Œæ•´ 7 å¤©æ•°æ®

---

## 2. æ•°æ®éœ€æ±‚

### 2.1 æ•°æ®æº

- **ä¸»è¡¨**: `quickbi_data.quickbi_campaigns`
- **æŸ¥è¯¢é€»è¾‘**: å–æ¯å¤©æœ€æ–° batch_id çš„æ•°æ®ï¼Œèšåˆ 7 å¤©

### 2.2 æ ¸å¿ƒæŒ‡æ ‡

| æŒ‡æ ‡ | è®¡ç®—æ–¹å¼ | è¯´æ˜ |
|------|----------|------|
| å‘¨æ€»æ¶ˆè€— | SUM(spend) | 7 å¤©ç´¯è®¡æ¶ˆè€— |
| å‘¨æ€»è¥æ”¶ | SUM(platform_total_revenue) | IAP + è®¢é˜… + å¹¿å‘Š |
| å‘¨å‡ ROAS | SUM(revenue) / SUM(spend) | åŠ æƒå¹³å‡ï¼Œéç®€å•å¹³å‡ |
| å‘¨ç¯æ¯” | (æœ¬å‘¨ - ä¸Šå‘¨) / ä¸Šå‘¨ | æ¶ˆè€—ã€è¥æ”¶ã€ROAS ç¯æ¯” |
| æ—¥å‡æ¶ˆè€— | å‘¨æ€»æ¶ˆè€— / 7 | è¯„ä¼°æŠ•æ”¾èŠ‚å¥ |

### 2.3 ç»´åº¦æ‹†åˆ†

| ç»´åº¦ | èšåˆæ–¹å¼ | ç”¨é€” |
|------|----------|------|
| æŠ•æ‰‹ (optimizer) | GROUP BY optimizer | æŠ•æ‰‹å‘¨åº¦æ’è¡Œ |
| å‰§é›† (drama_name) | GROUP BY drama_name | å‰§é›†æ•ˆæœè¯„ä¼° |
| å›½å®¶ (country) | GROUP BY country | å¸‚åœºè¡¨ç°åˆ†æ |
| æ¸ é“ (channel) | GROUP BY channel | æ¸ é“æ•ˆç‡å¯¹æ¯” |
| æ—¥æœŸ (stat_date) | GROUP BY stat_date | æ—¥è¶‹åŠ¿æ›²çº¿ |

---

## 3. æ’­æŠ¥æ¿å—è®¾è®¡

### 3.1 æ¿å— 1: å‘¨åº¦å¤§ç›˜ç»¼è¿°

**ç›®æ ‡**: ä¸€çœ¼çœ‹æ¸…æœ¬å‘¨æ•´ä½“è¡¨ç°

```
ğŸ“… [12.30-01.05] å‘¨åº¦å¤§ç›˜ç»¼è¿°
â€¢ å‘¨æ€»æ¶ˆè€—ï¼š$XXX,XXX (ğŸ“ˆ +15% å‘¨ç¯æ¯”)
â€¢ å‘¨æ€»è¥æ”¶ï¼š$XXX,XXX (ğŸ“ˆ +12% å‘¨ç¯æ¯”)
â€¢ å‘¨å‡ ROASï¼šXX.X% (ğŸ“‰ -2.1% å‘¨ç¯æ¯”)
â€¢ æ—¥å‡æ¶ˆè€—ï¼š$XX,XXX
â€¢ æ ¸å¿ƒè¯„ä»·ï¼šæ¶ˆè€—ç¨³æ­¥å¢é•¿ï¼ŒROAS å°å¹…å›è½ï¼Œéœ€å…³æ³¨æ•ˆç‡
```

**æ•°æ®å­—æ®µ**:
- `week_total_spend`: å‘¨æ€»æ¶ˆè€—
- `week_total_revenue`: å‘¨æ€»è¥æ”¶
- `week_avg_roas`: å‘¨å‡ ROAS
- `prev_week_*`: ä¸Šå‘¨åŒæœŸæ•°æ® (ç”¨äºç¯æ¯”)

### 3.2 æ¿å— 2: æ—¥è¶‹åŠ¿åˆ†æ

**ç›®æ ‡**: å±•ç¤º 7 å¤©æ¶ˆè€—å’Œ ROAS èµ°åŠ¿

```
ğŸ“ˆ æ—¥è¶‹åŠ¿
| æ—¥æœŸ  | æ¶ˆè€—      | ROAS   | è¶‹åŠ¿ |
|-------|-----------|--------|------|
| 12/30 | $12,345   | 42.1%  | ğŸ“ˆ   |
| 12/31 | $15,678   | 38.5%  | ğŸ“‰   |
| 01/01 | $8,234    | 45.2%  | ğŸ“ˆ   |
| ...   | ...       | ...    | ...  |
```

**æ•°æ®å­—æ®µ**:
- `daily_stats`: æ¯æ—¥ç»Ÿè®¡æ•°ç»„
  - `date`: æ—¥æœŸ
  - `spend`: å½“æ—¥æ¶ˆè€—
  - `roas`: å½“æ—¥ ROAS
  - `trend`: ç›¸æ¯”å‰ä¸€æ—¥çš„è¶‹åŠ¿

### 3.3 æ¿å— 3: æŠ•æ‰‹å‘¨åº¦æ’è¡Œ

**ç›®æ ‡**: è¯„ä¼°æŠ•æ‰‹å‘¨åº¦è¡¨ç°ï¼Œè¯†åˆ« MVP å’Œéœ€å…³æ³¨å¯¹è±¡

```
ğŸ† æŠ•æ‰‹å‘¨åº¦æ’è¡Œ
1. kino: è€— $5.2w | ROAS 45.2% (ğŸŒŸ MVP)
2. kimi: è€— $4.8w | ROAS 42.1% (ğŸ“ˆ +3.2%)
3. juria: è€— $3.5w | ROAS 38.5%
4. hannibal: è€— $2.8w | ROAS 28.5% (ğŸš¨ éœ€å…³æ³¨)
5. zane: è€— $1.2w | ROAS 52.1% (ğŸ“ˆ +8.5%)
```

**è¯„çº§è§„åˆ™**:
- ğŸŒŸ MVP: å‘¨æ¶ˆè€— Top1 ä¸” ROAS >= 40%
- ğŸ“ˆ è¿›æ­¥: ROAS å‘¨ç¯æ¯” > +5%
- ğŸš¨ éœ€å…³æ³¨: ROAS < 30%

**æ•°æ®å­—æ®µ**:
- `optimizer_weekly`: æŠ•æ‰‹å‘¨åº¦æ•°æ®æ•°ç»„
  - `name`: æŠ•æ‰‹åç§°
  - `spend`: å‘¨æ¶ˆè€—
  - `roas`: å‘¨å‡ ROAS
  - `roas_change`: ROAS å‘¨ç¯æ¯”
  - `rating`: è¯„çº§æ ‡ç­¾

### 3.4 æ¿å— 4: å‰§é›†å‘¨åº¦è¡¨ç°

**ç›®æ ‡**: è¯†åˆ«å¤´éƒ¨å‰§é›†ã€æ½œåŠ›å‰§é›†ã€è¡°é€€å‰§é›†

```
ğŸ¬ å‰§é›†å‘¨åº¦è¡¨ç°
ã€å¤´éƒ¨å‰§é›†ã€‘æ¶ˆè€— > $10k ä¸” ROAS > 40%
1. ã€Šå‰§é›†Aã€‹: è€— $2.5w | ROAS 48.2% | ä¸»æŠ•: US, KR
2. ã€Šå‰§é›†Bã€‹: è€— $1.8w | ROAS 45.1% | ä¸»æŠ•: JP

ã€æ½œåŠ›å‰§é›†ã€‘æ¶ˆè€— $1k-$10k ä¸” ROAS > 50%
1. ã€Šå‰§é›†Cã€‹: è€— $5.2k | ROAS 62.3% â­ å»ºè®®æ”¾é‡

ã€è¡°é€€é¢„è­¦ã€‘ROAS å‘¨ç¯æ¯”ä¸‹é™ > 10%
1. ã€Šå‰§é›†Dã€‹: ROAS 32.1% (ğŸ“‰ -15.2%)
```

**æ•°æ®å­—æ®µ**:
- `top_dramas`: å¤´éƒ¨å‰§é›†
- `potential_dramas`: æ½œåŠ›å‰§é›†
- `declining_dramas`: è¡°é€€å‰§é›†

### 3.5 æ¿å— 5: å¸‚åœºåˆ†æ

**ç›®æ ‡**: è¯†åˆ«é«˜æ•ˆå¸‚åœºå’Œæ–°å…´æœºä¼š

```
ğŸŒ å¸‚åœºåˆ†æ
ã€ä¸»åŠ›å¸‚åœºã€‘æ¶ˆè€— Top 5
| å›½å®¶ | æ¶ˆè€—    | ROAS   | å‘¨ç¯æ¯” |
|------|---------|--------|--------|
| US   | $8.5w   | 42.1%  | +5.2%  |
| KR   | $5.2w   | 38.5%  | -2.1%  |
| JP   | $3.8w   | 45.2%  | +8.3%  |

ã€æ–°å…´æœºä¼šã€‘éä¸»æŠ•å›½å®¶ï¼ŒROAS > 50%
â€¢ TW: ROAS 58.2% (æ¶ˆè€— $2.1k) å»ºè®®æµ‹è¯•æ”¾é‡
```

**æ•°æ®å­—æ®µ**:
- `top_countries`: ä¸»åŠ›å¸‚åœº
- `emerging_markets`: æ–°å…´æœºä¼šå¸‚åœº

### 3.6 æ¿å— 6: AI å‘¨åº¦æ´å¯Ÿ

**ç›®æ ‡**: åˆ©ç”¨ AI ç”Ÿæˆå‘¨åº¦ç­–ç•¥å»ºè®®

```
ğŸ¤– AI å‘¨åº¦æ´å¯Ÿ [GPT]
â€¢ æ ¸å¿ƒå‘ç°ï¼šæœ¬å‘¨ US å¸‚åœº ROAS æŒç»­èµ°é«˜ï¼Œå»ºè®®åŠ å¤§é¢„ç®—
â€¢ é£é™©æç¤ºï¼šã€Šå‰§é›†Dã€‹è¿ç»­3å¤© ROAS ä¸‹æ»‘ï¼Œå»ºè®®é™ä½å‡ºä»·
â€¢ ä¸‹å‘¨å»ºè®®ï¼šé‡ç‚¹æµ‹è¯• TW å¸‚åœºï¼Œæ½œåŠ›å‰§é›†ã€Šå‰§é›†Cã€‹å¯æ”¾é‡
```

**æ•°æ®å­—æ®µ**:
- `ai_insights`: AI åˆ†æç»“æœ
  - `key_findings`: æ ¸å¿ƒå‘ç°
  - `risk_alerts`: é£é™©æç¤º
  - `next_week_suggestions`: ä¸‹å‘¨å»ºè®®

---

## 4. æŠ€æœ¯å®ç°

### 4.1 æ–°å¢æ–¹æ³•

| æ¨¡å— | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `bigquery_storage.py` | `query_weekly_report_data()` | æŸ¥è¯¢å‘¨æŠ¥æ•°æ® |
| `lark_bot.py` | `send_weekly_report()` | å‘é€å‘¨æŠ¥é£ä¹¦æ¶ˆæ¯ |
| `scheduler_local.py` | `run_weekly_report()` | å‘¨æŠ¥è°ƒåº¦ä»»åŠ¡ |
| `chatgpt_advisor.py` | `analyze_weekly_data()` | AI å‘¨åº¦åˆ†æ |

### 4.2 æ ¸å¿ƒ SQL æŸ¥è¯¢

```sql
-- å‘¨åº¦å¤§ç›˜æ±‡æ€»
SELECT
    SUM(spend) as week_total_spend,
    SUM(media_user_revenue) as week_total_revenue,
    SAFE_DIVIDE(SUM(media_user_revenue), SUM(spend)) as week_avg_roas
FROM `quickbi_data.quickbi_campaigns`
WHERE stat_date BETWEEN @week_start AND @week_end
  AND batch_id IN (
    SELECT MAX(batch_id) FROM `quickbi_data.quickbi_campaigns`
    WHERE stat_date BETWEEN @week_start AND @week_end
    GROUP BY stat_date
  )
```

### 4.3 è°ƒåº¦é…ç½®

```python
# scheduler_local.py
schedule.every().monday.at("09:30").do(run_weekly_report)
```

### 4.4 è¿”å›æ•°æ®ç»“æ„

```python
{
    "week_start": "2024-12-30",
    "week_end": "2025-01-05",

    # å¤§ç›˜æ±‡æ€»
    "summary": {
        "week_total_spend": 150000.0,
        "week_total_revenue": 65000.0,
        "week_avg_roas": 0.433,
        "daily_avg_spend": 21428.57
    },

    # ä¸Šå‘¨æ•°æ® (ç¯æ¯”)
    "prev_week_summary": {
        "week_total_spend": 130000.0,
        "week_total_revenue": 58000.0,
        "week_avg_roas": 0.446
    },

    # æ—¥è¶‹åŠ¿
    "daily_stats": [
        {"date": "2024-12-30", "spend": 20000, "roas": 0.42},
        ...
    ],

    # æŠ•æ‰‹å‘¨åº¦
    "optimizer_weekly": [...],

    # å‰§é›†åˆ†ç±»
    "top_dramas": [...],
    "potential_dramas": [...],
    "declining_dramas": [...],

    # å¸‚åœºåˆ†æ
    "top_countries": [...],
    "emerging_markets": [...],

    # AI æ´å¯Ÿ
    "ai_insights": {...}
}
```

---

## 5. å®ç°ä¼˜å…ˆçº§

### P0 - æ ¸å¿ƒåŠŸèƒ½
1. `query_weekly_report_data()` - å‘¨æŠ¥æ•°æ®æŸ¥è¯¢
2. `send_weekly_report()` - é£ä¹¦æ¶ˆæ¯å‘é€
3. å‘¨åº¦å¤§ç›˜ç»¼è¿°æ¿å—
4. æŠ•æ‰‹å‘¨åº¦æ’è¡Œæ¿å—

### P1 - é‡è¦åŠŸèƒ½
5. æ—¥è¶‹åŠ¿åˆ†ææ¿å—
6. å‰§é›†å‘¨åº¦è¡¨ç°æ¿å—
7. å¸‚åœºåˆ†ææ¿å—
8. å‘¨ç¯æ¯”è®¡ç®—

### P2 - å¢å¼ºåŠŸèƒ½
9. AI å‘¨åº¦æ´å¯Ÿ
10. è°ƒåº¦ä»»åŠ¡é›†æˆ

---

## 6. ä¸ç°æœ‰æŠ¥è¡¨å¯¹æ¯”

| ç»´åº¦ | æ—¥æŠ¥ | å®æ—¶æ’­æŠ¥ | å‘¨æŠ¥ |
|------|------|----------|------|
| è§¦å‘æ—¶é—´ | æ¯æ—¥ 09:10 | æ¯å°æ—¶æ•´ç‚¹ | æ¯å‘¨ä¸€ 09:30 |
| æ•°æ®èŒƒå›´ | T-1 æ—¥ | å½“æ—¥ç´¯è®¡ | W-1 å‘¨ (7å¤©) |
| ç›®æ ‡ç”¨æˆ· | ç®¡ç†å±‚ | æ‰§è¡Œå±‚ | ç®¡ç†å±‚ + æŠ•æ”¾è´Ÿè´£äºº |
| æ ¸å¿ƒä»·å€¼ | æ˜¨æ—¥å¤ç›˜ | å®æ—¶ç›‘æ§ | è¶‹åŠ¿åˆ†æ + ç­–ç•¥å¤ç›˜ |
| ç¯æ¯”åŸºå‡† | T-2 æ—¥ | ä¸Šä¸€å°æ—¶ | W-2 å‘¨ |

---

## 7. éªŒæ”¶æ ‡å‡†

- [ ] æ¯å‘¨ä¸€ 09:30 è‡ªåŠ¨è§¦å‘å‘¨æŠ¥
- [ ] å‘¨æŠ¥åŒ…å« 6 ä¸ªæ ¸å¿ƒæ¿å—
- [ ] å‘¨ç¯æ¯”æ•°æ®å‡†ç¡®
- [ ] é£ä¹¦æ¶ˆæ¯æ ¼å¼æ­£ç¡®æ˜¾ç¤º
- [ ] AI æ´å¯Ÿæ­£å¸¸ç”Ÿæˆ
