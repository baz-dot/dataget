# 实时战报数据来源说明

## 📊 数据源

- **数据表：** `quickbi_data.quickbi_campaigns`
- **数据量：** 14.5万条（55 MB）
- **更新：** 每小时自动同步
- **来源：** 阿里云 QuickBI API

---

## 🎯 核心指标

| 飞书显示 | 数据来源 |
|---------|---------|
| 截止当前总耗 | `SUM(spend)` - 当日累计 |
| 截止当前收入 | `SUM(media_user_revenue)` - ✅ 媒体归因收入 |
| 当前 Media ROAS | `收入 / 消耗` |
| 日环比 | 与昨天同时刻对比 |
| 新增消耗 | 当前累计 - 上小时累计 |
| ROAS 趋势 | 当前 ROAS - 上小时 ROAS（绝对值） |

**关键点：**
- ✅ 收入用 `media_user_revenue`，比旧方案多 26.7%
- ⚠️ ROAS 环比用绝对值（49.2% - 48.8% = +0.4%），不是百分比

---

## 📋 各板块数据

| 板块 | 数据来源 | 筛选条件 |
|-----|---------|---------|
| 🔍 投手表格 | 按 `optimizer` 分组汇总 | - |
| 🔴 止损预警 | 按 `campaign_id` 分组 | 消耗 > $300 且 ROAS < 30% |
| 🟢 扩量机会 | 按 `campaign_id` 分组 | 消耗 > $300 且 ROAS > 50% |
| 🌍 地区观察 | 按 `country` 分组 | 消耗 > $100 且 ROAS > 50% |

**所有 ROAS 均为：** `media_user_revenue / spend`

---

## 🔑 关键机制：batch_id

### 什么是 batch_id？

batch_id 是数据快照的唯一标识，格式：`YYYYMMDD_HHMMSS`

**示例：** `20251225_140033` = 2025-12-25 14:00:33 的数据快照

### 为什么需要 batch_id？

实时播报需要对比 **3 个时间点** 的数据：

| 时间点 | 用途 | 示例 |
|-------|------|------|
| 当前 batch | 当前累计数据 | `20251225_140033` (今天 14:00) |
| 昨天同时刻 batch | 日环比对比 | `20251224_140015` (昨天 14:00) |
| 上一整点 batch | 小时环比对比 | `20251225_130029` (今天 13:00) |

**查询逻辑：**
```sql
-- 所有查询都加上 batch_id 过滤
WHERE stat_date = '2025-12-25' AND batch_id = '20251225_140033'
```

---

## ✅ 数据质量保证

### 1. 收入指标已优化

| 指标 | 旧方案 | 新方案 | 差异 |
|-----|-------|-------|------|
| 收入字段 | `new_user_revenue` | `media_user_revenue` | +26.7% |
| 说明 | 新用户首日收入（保守） | 媒体归因收入（准确） | 更符合行业标准 |

**代码位置：**
- `lark_bot.py:1364` - 飞书播报使用 `total_media_revenue`
- `bigquery_storage.py:1229` - SQL 查询 `SUM(media_user_revenue)`

### 2. ROAS 计算统一

所有 ROAS 均为 **Media ROAS**：

```sql
Media ROAS = SAFE_DIVIDE(SUM(media_user_revenue), SUM(spend))
```

**适用范围：**
- 大盘 ROAS
- 投手 ROAS
- 止损预警 ROAS
- 扩量机会 ROAS
- 地区 ROAS

### 3. 数据时效性

- **采集频率：** 每小时自动同步
- **延迟检测：** 超过2小时会发送告警
- **数据完整性：** 包含投手、剧集、国家等多维度数据

---

## 📈 数据统计

### 当前数据规模

- **总记录数：** 145,536 条
- **数据大小：** 54.99 MB
- **覆盖时间：** 多天历史数据
- **数据维度：** 投手、剧集、国家、渠道等

### 数据更新机制

1. **QuickBI 数据采集器** 每小时运行一次（Cloud Run Job）
2. 生成新的 **batch_id**（如 `20251225_140033`）
3. 写入 **BigQuery** `quickbi_data.quickbi_campaigns` 表
4. **实时播报** 查询最新 batch_id 的数据
5. 发送到 **飞书群**

---

## 🎯 总结

### 核心要点

1. ✅ **数据源统一**：所有数据来自 `quickbi_data.quickbi_campaigns` 表
2. ✅ **收入字段正确**：使用 `media_user_revenue`（媒体归因收入）
3. ✅ **ROAS 计算统一**：所有 ROAS 均为 Media ROAS
4. ✅ **环比计算特殊**：ROAS 环比使用绝对值差异
5. ✅ **batch_id 机制**：通过 batch_id 实现时间点数据快照

### 数据可靠性

- 数据来源：阿里云 QuickBI（官方数据源）
- 更新频率：每小时自动同步
- 数据量：14.5万条记录，覆盖完整
- 质量保证：使用媒体归因收入，更准确

---

**文档创建时间：** 2025-12-25
**详细文档：** `realtime_report_complete_mapping.md`
